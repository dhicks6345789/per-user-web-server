name: pangolin
services:
  # Webconsole - a handy way to run console applications directly in the browser. See: https://github.com/dhicks6345789/web-console
  webconsole:
    image: {{WEBCONSOLE_DOCKER_IMAGE}}
    container_name: webconsole
    command: /usr/local/bin/webconsole --debug --localOnly false
    networks:
      - main
    volumes:
      - /etc/webconsole:/etc/webconsole

  # A Cloudflare Zero-Trust tunnel. Requires an access token obtained from the Cloudflare console.
  # Can provide both tunneling and authentication, used just as an option for tunneling here, with Pangolin used for authentication (and as an alternative for tunneling, if wanted).
  tunnel:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared-tunnel
    restart: unless-stopped
    command: tunnel --no-autoupdate run --token {{CLOUDFLARED_TOKEN}}
    networks:
      - main

  # Fossorial's Pangolin - can provide tunneling and authentication, basically a self-hostable version of Cloudflare Tunnels. See: https://pangolin.net
  pangolin:
    image: fosrl/pangolin:latest
    container_name: pangolin
    restart: unless-stopped
    networks:
      - main
    volumes:
      - ./config:/app/config
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/api/v1/"]
      interval: "10s"
      timeout: "10s"
      retries: 15
  
  # Part of Fossorial's containerised Pangolin setup. A reverse proxy.
  traefik:
    image: traefik:latest
    container_name: traefik
    restart: unless-stopped

    depends_on:
      pangolin:
        condition: service_healthy
    command:
      - --configFile=/etc/traefik/traefik_config.yml
    networks:
      - main
    volumes:
      - ./config/traefik:/etc/traefik:ro # Volume to store the Traefik configuration
      - ./config/letsencrypt:/letsencrypt # Volume to store the Let's Encrypt certificates
      - ./config/traefik/logs:/var/log/traefik # Volume to store Traefik logs
  
  # Guacd - The Apache Guacamole (web-based remote desktop) proxy daemon.
  # Note the lack of a database container instance, generally included in the standard containerised Guacamole setup.
  # This is because we are using our own custom authentication plugin to provide connection details for users logging in via Pangolin.
  guacd:
    image: guacamole/guacd:latest
    container_name: guacd
    restart: unless-stopped
    networks:
      - main
  
  # Guacamole Client - The Guacamole web interface.
  guacamole:
    image: guacamole/guacamole:latest
    container_name: guacamole
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      GUACD_HOSTNAME: guacd
      HTTP_AUTH_ENABLED: "true"
      HTTP_AUTH_HEADER: Remote-User
    depends_on:
      - guacd
    networks:
      - main
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      # /etc/guacamole is where the custom Java extension needs to be placed.
      - /etc/guacamole:/etc/guacamole
  
  # httpd - the Apache web server.
  httpd:
    image: httpd:latest
    container_name: httpd
    restart: unless-stopped
    networks:
      - main
# We have to create an explicitly named network, otheriwse automatic DNS resolution doesn't work with the default network when new containers are added via "docker run".
networks:
  main:
    driver: bridge
