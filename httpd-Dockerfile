FROM httpd:latest

# Update the package list and install Python 3.
RUN apt-get update && apt-get install -y --no-install-recommends python3 python3-pip && rm -rf /var/lib/apt/lists/*

# Install suEXEC, which allows us to limit how users can run CGI scripts.
RUN apt-get update && apt-get install -y apache2-suexec-custom
# Enable the suEXEC module.
RUN sed -i 's/#LoadModule suexec_module modules\/mod_suexec.so/LoadModule suexec_module modules\/mod_suexec.so/' /usr/local/apache2/conf/httpd.conf

# Update httpd.conf to use 'tee' for ErrorLog. This writes to the file AND redirects to stderr (fd/2).
RUN sed -i 's/ErrorLog \/proc\/self\/fd\/2/\/usr\/bin\/tee -a \/usr\/local\/apache2\/logs\/error_log > \/proc\/self\/fd\/2/' /usr/local/apache2/conf/httpd.conf
# Update httpd.conf to add a second CustomLog for the physical file. The original image already has one pointing to stdout (fd/1)
RUN echo 'CustomLog "/usr/local/apache2/logs/access_log" combined' >> /usr/local/apache2/conf/httpd.conf

# Append a single 'Include' line to the end of the main config so we can add our own config files without having to modify / replace the main httpd.conf.
RUN echo "IncludeOptional conf/sites-enabled/*.conf" >> /usr/local/apache2/conf/httpd.conf

# Uncomment the LoadModule line for cgid_module ("mod_cgi") so we can use that module in our own configs.
RUN sed -i 's/#LoadModule cgid_module/LoadModule cgid_module/' /usr/local/apache2/conf/httpd.conf

# Enable mod_userdir
RUN sed -i 's/#LoadModule userdir_module/LoadModule userdir_module/' /usr/local/apache2/conf/httpd.conf

# Create a directory for our custom Apache config files.
RUN mkdir -p /usr/local/apache2/conf/sites-enabled/

# Copy our configs into that directory.
COPY per-user-web-server/users-www.conf /usr/local/apache2/conf/sites-enabled/
